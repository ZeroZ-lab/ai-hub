# Module 1 - 代码示例：从零开始运行你的第一个 Agent

> 本文档提供可运行的代码示例，帮助你快速上手 Claude Agent SDK。

## 最小可运行示例

### 环境准备

#### 1. 检查 Python 版本
```bash
# 确保 Python 版本 >= 3.10
python --version
# 或
python3 --version

# 如果版本不够，请先安装 Python 3.10+
```

#### 2. 创建项目目录（使用 uv）

**方式 1：使用 uv 初始化项目（推荐）**
```bash
# 使用 uv 创建新项目
uv init my_first_agent
cd my_first_agent

# uv 会自动创建 pyproject.toml
```

**方式 2：手动创建**
```bash
# 创建项目文件夹
mkdir my_first_agent
cd my_first_agent

# 初始化 uv 项目
uv init
```

#### 3. 安装依赖
```bash
# 使用 uv 安装依赖（自动创建虚拟环境）
uv add anthropic python-dotenv

# 验证安装
uv pip list | grep anthropic

# 或查看 pyproject.toml
cat pyproject.toml
```

**uv 的优势**：
- ⚡ 比 pip 快 10-100 倍
- 🔒 自动锁定依赖版本
- 🎯 无需手动创建虚拟环境
- 📦 统一的依赖管理

#### 4. 配置 API Key

**步骤 1：获取 API Key**
1. 访问 [Anthropic Console](https://console.anthropic.com/)
2. 注册/登录账号
3. 前往 "API Keys" 页面
4. 点击 "Create Key"
5. 复制生成的 API Key（格式：`sk-ant-api03-...`）

**步骤 2：创建环境变量文件**
```bash
# 创建 .env 文件
touch .env

# 编辑 .env（使用任意文本编辑器）
# 添加以下内容：
# ANTHROPIC_API_KEY=sk-ant-api03-你的实际密钥
```

⚠️ **重要**：`.env` 文件包含敏感信息，永远不要提交到 Git！
```bash
# 创建 .gitignore
echo ".env" >> .gitignore
echo "venv/" >> .gitignore


**使用自定义 API 的说明**：
- 如果你使用的是 API 代理或兼容 Claude API 的其他服务，可以设置 `ANTHROPIC_BASE_URL`
- 示例：`ANTHROPIC_BASE_URL=https://api.your-service.com/v1`
- 如果不设置，默认使用 Anthropic 官方 API
```

---

## Hello World 示例

### 版本 1：最简单的调用

创建文件 `hello.py`：

```python
"""
Hello World: 最简单的 Claude API 调用
"""

import os
from anthropic import Anthropic
from dotenv import load_dotenv

# 加载环境变量
load_dotenv()

def hello_claude():
    """最简单的 Claude 调用示例"""
    # 创建客户端
    client = Anthropic(api_key=os.getenv("ANTHROPIC_API_KEY"))

    # 调用 API
    response = client.messages.create(
        model="claude-3-5-sonnet-20241022",
        max_tokens=1024,
        messages=[
            {"role": "user", "content": "Say hello in Chinese!"}
        ]
    )

    # 打印响应
    print(response.content[0].text)

if __name__ == "__main__":
    hello_claude()
```

**运行**：
```bash
# 使用 uv 运行
uv run hello.py

# 或使用传统方式（如果已激活虚拟环境）
python hello.py
```

**预期输出**：
```
你好！很高兴见到你。有什么我可以帮助你的吗？
```

---

### 版本 2：带错误处理的版本

创建文件 `hello_safe.py`：

```python
"""
Hello World: 带错误处理的安全版本
"""

import os
import sys
from anthropic import Anthropic, APIError
from dotenv import load_dotenv

load_dotenv()


def hello_claude_safe():
    """带完善错误处理的 Claude 调用"""
    # 1. 检查 API Key
    api_key = os.getenv("ANTHROPIC_API_KEY")
    if not api_key:
        print("❌ 错误：未找到 ANTHROPIC_API_KEY")
        print("请检查：")
        print("  1. .env 文件是否存在")
        print("  2. .env 中是否设置了 ANTHROPIC_API_KEY=...")
        print("  3. 是否调用了 load_dotenv()")
        sys.exit(1)

    # 2. 创建客户端
    client = Anthropic(api_key=api_key)

    # 3. 调用 API（带错误处理）
    try:
        print("🤖 正在调用 Claude API...")

        response = client.messages.create(
            model="claude-3-5-sonnet-20241022",
            max_tokens=1024,
            messages=[
                {"role": "user", "content": "用中文说你好"}
            ]
        )

        # 4. 提取回复
        reply = response.content[0].text
        print(f"✅ Claude: {reply}")

        # 5. 显示 Token 使用情况
        print(f"\n📊 Token 使用:")
        print(f"  输入: {response.usage.input_tokens} tokens")
        print(f"  输出: {response.usage.output_tokens} tokens")
        print(f"  总计: {response.usage.input_tokens + response.usage.output_tokens} tokens")

    except APIError as e:
        print(f"❌ API 错误: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"❌ 未知错误: {e}")
        sys.exit(1)


if __name__ == "__main__":
    hello_claude_safe()
```

**运行**：
```bash
uv run hello_safe.py
```

**预期输出**：
```
🤖 正在调用 Claude API...
✅ Claude: 你好！很高兴见到你。

📊 Token 使用:
  输入: 15 tokens
  输出: 12 tokens
  总计: 27 tokens
```

---

## 完整功能示例：对话助手

### 示例 1：多轮对话

创建文件 `chat_agent.py`：

```python
"""
完整示例：支持多轮对话的 Agent

这个示例展示了：
1. 如何维护对话历史
2. 如何实现交互式对话循环
3. 如何优雅地处理用户输入
"""

import os
from typing import List, Dict
from anthropic import Anthropic, APIError
from dotenv import load_dotenv

load_dotenv()


class ChatAgent:
    """简单的对话 Agent

    Attributes:
        client: Anthropic 客户端
        model: 使用的模型名称
        conversation_history: 对话历史记录
    """

    def __init__(self, model: str = "claude-3-5-sonnet-20241022"):
        """初始化 Agent

        Args:
            model: Claude 模型名称
        """
        api_key = os.getenv("ANTHROPIC_API_KEY")
        if not api_key:
            raise ValueError("请设置 ANTHROPIC_API_KEY 环境变量")

        self.client = Anthropic(api_key=api_key)
        self.model = model
        self.conversation_history: List[Dict] = []

    def chat(self, user_message: str) -> str:
        """发送消息并获取响应

        Args:
            user_message: 用户输入

        Returns:
            Agent 的回复
        """
        # 添加用户消息到历史
        self.conversation_history.append({
            "role": "user",
            "content": user_message
        })

        try:
            # 调用 API
            response = self.client.messages.create(
                model=self.model,
                max_tokens=1024,
                messages=self.conversation_history
            )

            # 提取回复
            assistant_message = response.content[0].text

            # 添加助手回复到历史
            self.conversation_history.append({
                "role": "assistant",
                "content": assistant_message
            })

            return assistant_message

        except APIError as e:
            return f"抱歉，发生了错误: {e}"

    def reset(self):
        """重置对话历史"""
        self.conversation_history = []
        print("✨ 对话历史已清空")

    def show_history(self):
        """显示对话历史"""
        print("\n📜 对话历史:")
        for i, msg in enumerate(self.conversation_history, 1):
            role = "👤 你" if msg["role"] == "user" else "🤖 Agent"
            print(f"{i}. {role}: {msg['content'][:50]}...")


def main():
    """主函数：运行交互式对话"""
    print("=" * 60)
    print("🤖 Claude Agent 对话助手")
    print("=" * 60)
    print("\n命令:")
    print("  输入消息 - 开始对话")
    print("  /reset   - 清空对话历史")
    print("  /history - 查看对话历史")
    print("  /exit    - 退出程序")
    print("=" * 60)

    # 创建 Agent
    agent = ChatAgent()

    print("\nAgent: 你好！我是你的 AI 助手，有什么可以帮到你的吗？")

    while True:
        # 获取用户输入
        user_input = input("\n你: ").strip()

        # 处理命令
        if not user_input:
            continue

        if user_input.lower() in ['/exit', '/quit', '退出']:
            print("\nAgent: 再见！👋")
            break

        if user_input.lower() == '/reset':
            agent.reset()
            continue

        if user_input.lower() == '/history':
            agent.show_history()
            continue

        # 正常对话
        response = agent.chat(user_input)
        print(f"\nAgent: {response}")


if __name__ == "__main__":
    main()
```

**运行**：
```bash
uv run chat_agent.py
```

**交互示例**：
```
============================================================
🤖 Claude Agent 对话助手
============================================================

命令:
  输入消息 - 开始对话
  /reset   - 清空对话历史
  /history - 查看对话历史
  /exit    - 退出程序
============================================================

Agent: 你好！我是你的 AI 助手，有什么可以帮到你的吗？

你: 你好，我想学习 Python

Agent: 很高兴你想学习 Python！Python 是一门非常适合初学者的编程语言...

你: 从哪里开始？

Agent: 基于我们刚才的对话，我建议你从以下几个方面开始...

你: /exit

Agent: 再见！👋
```

---

## 常见用法对比

### ✅ 好的实践 vs ❌ 不好的实践

#### 1. API Key 管理

❌ **危险做法**：
```python
# 硬编码 API Key - 千万不要这样做！
client = Anthropic(api_key="sk-ant-api03-xxxxx")
```

✅ **安全做法**：
```python
# 使用环境变量
from dotenv import load_dotenv
load_dotenv()

api_key = os.getenv("ANTHROPIC_API_KEY")
client = Anthropic(api_key=api_key)
```

---

#### 2. 错误处理

❌ **不好的做法**：
```python
# 没有错误处理，API 失败时程序崩溃
response = client.messages.create(...)
print(response.content[0].text)
```

✅ **好的做法**：
```python
try:
    response = client.messages.create(...)
    print(response.content[0].text)
except APIError as e:
    print(f"API 调用失败: {e}")
    # 实现降级方案或重试
```

---

#### 3. 对话历史管理

❌ **不好的做法**：
```python
# 每次都是新对话，无法理解上下文
def chat(message):
    response = client.messages.create(
        messages=[{"role": "user", "content": message}]
    )
    return response.content[0].text
```

✅ **好的做法**：
```python
class Agent:
    def __init__(self):
        self.history = []

    def chat(self, message):
        self.history.append({"role": "user", "content": message})
        response = client.messages.create(messages=self.history)
        reply = response.content[0].text
        self.history.append({"role": "assistant", "content": reply})
        return reply
```

---

## API 参考快查

### `client.messages.create()` 核心参数

```python
response = client.messages.create(
    # 必需参数
    model="claude-3-5-sonnet-20241022",  # 模型选择
    max_tokens=1024,                      # 最大输出长度
    messages=[                            # 对话历史
        {"role": "user", "content": "你好"}
    ],

    # 可选参数
    system="你是一个友好的助手",          # 系统提示
    temperature=1.0,                      # 创造性 (0-1)
    top_p=1.0,                           # 采样参数
    stop_sequences=["\n\n"],             # 停止序列
)
```

### 模型选择指南

| 模型 | 特点 | 适用场景 | 相对成本 |
|------|------|----------|---------|
| `claude-3-5-sonnet-20241022` | 平衡性能和成本 | 大多数应用 | 中 |
| `claude-3-opus-20240229` | 最强性能 | 复杂推理任务 | 高 |
| `claude-3-haiku-20240307` | 最快速度 | 简单对话 | 低 |

### 响应对象结构

```python
response = {
    "id": "msg_01XYZ...",
    "type": "message",
    "role": "assistant",
    "content": [
        {
            "type": "text",
            "text": "这是实际的回复内容"
        }
    ],
    "model": "claude-3-5-sonnet-20241022",
    "stop_reason": "end_turn",  # 或 "max_tokens", "stop_sequence"
    "usage": {
        "input_tokens": 10,
        "output_tokens": 25
    }
}

# 提取回复文本
reply = response.content[0].text

# 查看 token 使用
total_tokens = response.usage.input_tokens + response.usage.output_tokens
```

---

## 调试技巧

### 1. 打印完整响应

```python
import json

response = client.messages.create(...)

# 方法 1：直接打印（Pydantic 对象）
print(response)

# 方法 2：转为字典查看
print(response.model_dump())

# 方法 3：格式化 JSON 输出
print(json.dumps(response.model_dump(), indent=2, ensure_ascii=False))
```

---

### 2. 使用日志记录

```python
import logging

# 配置日志
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def chat(message):
    logger.info(f"用户输入: {message}")

    response = client.messages.create(...)

    logger.debug(f"API 响应: {response.model_dump()}")
    logger.info(f"Token 使用: {response.usage}")

    return response.content[0].text
```

---

### 3. Token 计数监控

```python
class TokenTracker:
    """Token 使用追踪器"""
    def __init__(self):
        self.total_input = 0
        self.total_output = 0

    def track(self, response):
        """记录单次请求的 token 使用"""
        self.total_input += response.usage.input_tokens
        self.total_output += response.usage.output_tokens

        print(f"本次: {response.usage.input_tokens} + {response.usage.output_tokens}")
        print(f"累计: {self.total_input} + {self.total_output} = {self.total_input + self.total_output}")

# 使用
tracker = TokenTracker()
response = client.messages.create(...)
tracker.track(response)
```

---

## 常见问题 (FAQ)

### Q1: 为什么收到 "401 Unauthorized" 错误？

**原因**：API Key 无效或未正确配置

**解决方案**：
1. 检查 `.env` 文件是否存在
2. 确认 `ANTHROPIC_API_KEY` 的值正确（以 `sk-ant-` 开头）
3. 确保调用了 `load_dotenv()`
4. 尝试重新生成 API Key

```python
# 调试代码
import os
from dotenv import load_dotenv

load_dotenv()
api_key = os.getenv("ANTHROPIC_API_KEY")

print(f"API Key 已加载: {api_key[:20]}..." if api_key else "❌ 未找到 API Key")
```

---

### Q2: 如何限制响应长度？

**方法 1：使用 `max_tokens`**
```python
response = client.messages.create(
    max_tokens=100,  # 限制为 100 tokens（约 75 个英文单词）
    ...
)
```

**方法 2：在提示中说明**
```python
messages = [{
    "role": "user",
    "content": "用一句话总结人工智能的定义"
}]
```

---

### Q3: 如何让 Agent 扮演特定角色？

使用 `system` 参数：

```python
response = client.messages.create(
    model="claude-3-5-sonnet-20241022",
    max_tokens=1024,
    system="你是一个专业的 Python 编程导师，擅长用简单的语言解释复杂概念。",
    messages=[
        {"role": "user", "content": "什么是装饰器？"}
    ]
)
```

---

### Q4: 对话历史太长怎么办？

**策略 1：保留最近 N 轮对话**
```python
MAX_HISTORY = 10  # 保留最近 10 条消息

def add_message(history, new_msg):
    history.append(new_msg)
    if len(history) > MAX_HISTORY:
        history = history[-MAX_HISTORY:]
    return history
```

**策略 2：总结旧对话**
```python
# 当历史超过阈值，让 Claude 总结前面的对话
if len(history) > 20:
    summary = summarize_conversation(history[:10])
    history = [{"role": "user", "content": f"之前的对话摘要：{summary}"}] + history[10:]
```

---

## 性能优化小贴士

### 1. 减少不必要的 Token

```python
# ❌ 冗长的提示
prompt = """
请帮我分析以下文本，并提供详细的见解和建议。
请务必考虑所有可能的角度，包括但不限于...
[很长的说明]
"""

# ✅ 简洁的提示
prompt = "分析这段文本的情感倾向："
```

---

### 2. 合理设置 max_tokens

```python
# 根据实际需求设置
response = client.messages.create(
    max_tokens=512,  # 短回复
    # max_tokens=2048,  # 中等长度
    # max_tokens=4096,  # 长文本生成
    ...
)
```

---

## 下一步

✅ 掌握了代码示例后：
- 阅读 **[03_最佳实践.md](03_最佳实践.md)** - 学习生产环境注意事项
- 完成 **[project_01_hello_agent](../projects/project_01_hello_agent/)** - 动手实践

💡 **建议**：
1. 先运行所有示例代码，确保能跑通
2. 尝试修改参数，观察效果变化
3. 基于示例代码，实现自己的需求

---

**开始编码吧！🚀**
