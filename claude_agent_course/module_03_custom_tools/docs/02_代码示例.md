# Module 3 - 代码示例：自定义工具实战

> 本文档提供自定义工具的完整代码示例。

## 环境准备

```bash
cd your_project
uv add claude-agent-sdk python-dotenv
```

---

## 示例 1：简单计算器

```python
"""
示例：创建计算器工具
"""

import asyncio
from claude_agent_sdk import (
    tool,
    create_sdk_mcp_server,
    ClaudeAgentOptions,
    query
)

# 定义工具
@tool("add", "Add two numbers", {"a": float, "b": float})
async def add(args):
    result = args["a"] + args["b"]
    return {"content": [{"type": "text", "text": f"{args['a']} + {args['b']} = {result}"}]}

@tool("subtract", "Subtract two numbers", {"a": float, "b": float})
async def subtract(args):
    result = args["a"] - args["b"]
    return {"content": [{"type": "text", "text": f"{args['a']} - {args['b']} = {result}"}]}

@tool("multiply", "Multiply two numbers", {"a": float, "b": float})
async def multiply(args):
    result = args["a"] * args["b"]
    return {"content": [{"type": "text", "text": f"{args['a']} × {args['b']} = {result}"}]}

@tool("divide", "Divide two numbers", {"a": float, "b": float})
async def divide(args):
    if args["b"] == 0:
        return {"content": [{"type": "text", "text": "错误: 除数不能为0"}], "is_error": True}
    result = args["a"] / args["b"]
    return {"content": [{"type": "text", "text": f"{args['a']} ÷ {args['b']} = {result}"}]}

# 创建服务器
calculator = create_sdk_mcp_server(
    name="calc",
    version="1.0.0",
    tools=[add, subtract, multiply, divide]
)

# 配置选项
options = ClaudeAgentOptions(
    mcp_servers={"calc": calculator},
    allowed_tools=["mcp__calc__add", "mcp__calc__subtract", "mcp__calc__multiply", "mcp__calc__divide"]
)

async def main():
    prompt = "请计算：(15 + 5) × 3 ÷ 2"
    async for msg in query(prompt=prompt, options=options):
        if hasattr(msg, 'text'):
            print(msg.text)

asyncio.run(main())
```

---

## 示例 2：结构化输出

```python
"""
示例：获取结构化 JSON 输出
"""

import asyncio
from claude_agent_sdk import query, ClaudeAgentOptions

# 定义输出 Schema
resume_schema = {
    "type": "object",
    "properties": {
        "name": {"type": "string", "description": "候选人姓名"},
        "email": {"type": "string", "description": "邮箱地址"},
        "phone": {"type": "string", "description": "电话号码"},
        "skills": {
            "type": "array",
            "items": {"type": "string"},
            "description": "技能列表"
        },
        "experience_years": {"type": "integer", "description": "工作年限"},
        "education": {"type": "string", "description": "最高学历"}
    },
    "required": ["name", "skills"]
}

options = ClaudeAgentOptions(
    output_format={
        "type": "json_schema",
        "schema": resume_schema
    },
    max_turns=1
)

async def analyze_resume(resume_text: str):
    prompt = f"""
    请分析以下简历，提取关键信息：
    
    {resume_text}
    """
    
    async for msg in query(prompt=prompt, options=options):
        if hasattr(msg, 'structured_output'):
            return msg.structured_output
    return None

# 测试
resume = """
张三
邮箱: zhangsan@example.com
电话: 13800138000

工作经验：5年
技能：Python, JavaScript, React, Docker

教育背景：本科，计算机科学
"""

asyncio.run(analyze_resume(resume))
```

---

## 示例 3：带验证的工具

```python
"""
示例：带参数验证的工具
"""

from claude_agent_sdk import tool

@tool(
    "send_email",
    "Send an email to a recipient",
    {
        "to": str,
        "subject": str,
        "body": str,
        "priority": str  # "low", "normal", "high"
    }
)
async def send_email(args):
    # 参数验证
    to = args.get("to", "")
    if not "@" in to:
        return {
            "content": [{"type": "text", "text": f"无效的邮箱地址: {to}"}],
            "is_error": True
        }
    
    priority = args.get("priority", "normal")
    if priority not in ["low", "normal", "high"]:
        return {
            "content": [{"type": "text", "text": f"无效的优先级: {priority}"}],
            "is_error": True
        }
    
    # 模拟发送邮件
    return {
        "content": [{
            "type": "text",
            "text": f"邮件已发送到 {to}，主题: {args['subject']}"
        }]
    }
```

---

## 示例 4：数据库查询工具

```python
"""
示例：模拟数据库查询工具
"""

from claude_agent_sdk import tool, create_sdk_mcp_server

# 模拟数据
USERS_DB = [
    {"id": 1, "name": "张三", "age": 28, "dept": "技术部"},
    {"id": 2, "name": "李四", "age": 32, "dept": "产品部"},
    {"id": 3, "name": "王五", "age": 25, "dept": "技术部"},
]

@tool("query_users", "Query users from database", {"dept": str})
async def query_users(args):
    dept = args.get("dept")
    results = [u for u in USERS_DB if u["dept"] == dept]
    
    if not results:
        return {"content": [{"type": "text", "text": f"未找到 {dept} 的用户"}]}
    
    text = f"找到 {len(results)} 个用户:\n"
    for u in results:
        text += f"- {u['name']} ({u['age']}岁)\n"
    
    return {"content": [{"type": "text", "text": text}]}

@tool("get_user", "Get user by ID", {"id": int})
async def get_user(args):
    user_id = args.get("id")
    for u in USERS_DB:
        if u["id"] == user_id:
            return {"content": [{"type": "text", "text": f"用户: {u['name']}, 年龄: {u['age']}, 部门: {u['dept']}"}]}
    
    return {"content": [{"type": "text", "text": f"用户 ID {user_id} 不存在"}], "is_error": True}

# 创建服务器
db_server = create_sdk_mcp_server(
    name="database",
    version="1.0.0",
    tools=[query_users, get_user]
)
```

---

## 示例 5：文件处理工具

```python
"""
示例：文件处理工具
"""

import json
from claude_agent_sdk import tool

@tool("parse_json", "Parse a JSON file", {"file_path": str})
async def parse_json(args):
    try:
        with open(args["file_path"], "r") as f:
            data = json.load(f)
        
        # 返回摘要
        if isinstance(data, list):
            summary = f"JSON 数组，包含 {len(data)} 个元素"
        elif isinstance(data, dict):
            summary = f"JSON 对象，包含 {len(data)} 个键: {list(data.keys())[:5]}"
        else:
            summary = f"JSON 值: {type(data).__name__}"
        
        return {"content": [{"type": "text", "text": summary}]}
    
    except FileNotFoundError:
        return {"content": [{"type": "text", "text": f"文件不存在: {args['file_path']}"}], "is_error": True}
    except json.JSONDecodeError as e:
        return {"content": [{"type": "text", "text": f"JSON 解析错误: {e}"}], "is_error": True}

@tool("count_lines", "Count lines in a file", {"file_path": str})
async def count_lines(args):
    try:
        with open(args["file_path"], "r") as f:
            lines = len(f.readlines())
        return {"content": [{"type": "text", "text": f"文件共 {lines} 行"}]}
    except Exception as e:
        return {"content": [{"type": "text", "text": f"错误: {e}"}], "is_error": True}
```

---

## API 参考

### @tool 装饰器

```python
@tool(
    name: str,           # 工具名称
    description: str,    # 描述（Agent 用于判断）
    params: dict         # 参数定义 {参数名: 类型}
)
async def my_tool(args: dict) -> dict:
    # 返回格式
    return {
        "content": [{"type": "text", "text": "结果"}],
        "is_error": False  # 可选，标记是否错误
    }
```

### create_sdk_mcp_server

```python
server = create_sdk_mcp_server(
    name="server_name",  # 服务器名
    version="1.0.0",     # 版本
    tools=[tool1, tool2] # 工具列表
)
```

### ClaudeAgentOptions

```python
options = ClaudeAgentOptions(
    mcp_servers={"name": server},     # MCP 服务器
    allowed_tools=["mcp__name__tool"], # 允许的工具
    output_format={                    # 结构化输出
        "type": "json_schema",
        "schema": {...}
    }
)
```

---

## 下一步

- 阅读 **[03_最佳实践.md](03_最佳实践.md)**
- 实战 **[project_01_resume_analyzer](../projects/project_01_resume_analyzer/)**
