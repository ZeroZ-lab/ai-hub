# Module 3 - æœ€ä½³å®è·µï¼šè‡ªå®šä¹‰å·¥å…·è®¾è®¡

> æœ¬æ–‡æ¡£æ€»ç»“è‡ªå®šä¹‰å·¥å…·å¼€å‘çš„æœ€ä½³å®è·µã€‚

## å·¥å…·è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£

```python
# âŒ ä¸å¥½ï¼šä¸€ä¸ªå·¥å…·åšå¤ªå¤šäº‹
@tool("process_data", "Process and save data", {...})
async def process_data(args):
    # è¯»å– + å¤„ç† + ä¿å­˜ + å‘é€é€šçŸ¥...
    pass

# âœ… å¥½ï¼šæ¯ä¸ªå·¥å…·èŒè´£æ¸…æ™°
@tool("parse_data", "Parse raw data", {...})
async def parse_data(args): ...

@tool("validate_data", "Validate data format", {...})
async def validate_data(args): ...

@tool("save_data", "Save data to storage", {...})
async def save_data(args): ...
```

### 2. æ¸…æ™°çš„æè¿°

```python
# âŒ ä¸å¥½ï¼šæè¿°æ¨¡ç³Š
@tool("calc", "Calculate", {"x": float})

# âœ… å¥½ï¼šæè¿°æ¸…æ™°ï¼ŒAgent çŸ¥é“ä½•æ—¶ä½¿ç”¨
@tool(
    "calculate_tax",
    "Calculate income tax based on salary. Use when user asks about tax calculation.",
    {"salary": float, "region": str}
)
```

### 3. å®Œå–„çš„é”™è¯¯å¤„ç†

```python
@tool("fetch_data", "Fetch data from API", {"url": str})
async def fetch_data(args):
    url = args.get("url", "")
    
    # 1. å‚æ•°éªŒè¯
    if not url.startswith("http"):
        return {
            "content": [{"type": "text", "text": "URL å¿…é¡»ä»¥ http å¼€å¤´"}],
            "is_error": True
        }
    
    try:
        # 2. ä¸šåŠ¡é€»è¾‘
        response = await http_client.get(url)
        return {"content": [{"type": "text", "text": response.text}]}
    
    except TimeoutError:
        # 3. ç‰¹å®šé”™è¯¯å¤„ç†
        return {
            "content": [{"type": "text", "text": "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•"}],
            "is_error": True
        }
    except Exception as e:
        # 4. é€šç”¨é”™è¯¯å¤„ç†
        return {
            "content": [{"type": "text", "text": f"è¯·æ±‚å¤±è´¥: {str(e)}"}],
            "is_error": True
        }
```

---

## å‚æ•°è®¾è®¡

### ä½¿ç”¨æœ‰æ„ä¹‰çš„å‚æ•°å

```python
# âŒ ä¸å¥½
@tool("search", "Search", {"q": str, "n": int})

# âœ… å¥½
@tool("search", "Search documents", {"query": str, "max_results": int})
```

### æä¾›é»˜è®¤å€¼

```python
@tool("search", "Search with options", {"query": str, "limit": int, "sort": str})
async def search(args):
    query = args["query"]
    limit = args.get("limit", 10)  # é»˜è®¤ 10
    sort = args.get("sort", "relevance")  # é»˜è®¤ç›¸å…³æ€§æ’åº
    ...
```

---

## å¸¸è§é™·é˜±

### é™·é˜± 1ï¼šå·¥å…·åå†²çª

```python
# âŒ ä¸¤ä¸ªæœåŠ¡å™¨æœ‰ç›¸åŒå·¥å…·åï¼Œå¯èƒ½æ··æ·†
server1 = create_sdk_mcp_server(name="s1", tools=[parse_tool])
server2 = create_sdk_mcp_server(name="s2", tools=[parse_tool])

# âœ… ä½¿ç”¨ä¸åŒæœåŠ¡å™¨ååŒºåˆ†
# mcp__s1__parse vs mcp__s2__parse
```

### é™·é˜± 2ï¼šè¿”å›æ ¼å¼é”™è¯¯

```python
# âŒ é”™è¯¯çš„è¿”å›æ ¼å¼
@tool("get_data", "Get data", {})
async def get_data(args):
    return "some data"  # é”™ï¼éœ€è¦ dict

# âœ… æ­£ç¡®çš„è¿”å›æ ¼å¼
async def get_data(args):
    return {"content": [{"type": "text", "text": "some data"}]}
```

### é™·é˜± 3ï¼šå¿˜è®° async

```python
# âŒ å¿˜è®° async
@tool("sync_tool", "A tool", {})
def sync_tool(args):  # é”™ï¼éœ€è¦ async
    return {...}

# âœ… æ­£ç¡®
@tool("async_tool", "A tool", {})
async def async_tool(args):
    return {...}
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é¿å…é˜»å¡æ“ä½œ

```python
# âŒ é˜»å¡
@tool("slow_io", "Read file", {"path": str})
async def slow_io(args):
    with open(args["path"]) as f:  # é˜»å¡ IO
        return f.read()

# âœ… å¼‚æ­¥ IO
import aiofiles
async def fast_io(args):
    async with aiofiles.open(args["path"]) as f:
        return await f.read()
```

### 2. ç»“æœç¼“å­˜

```python
from functools import lru_cache

cache = {}

@tool("cached_query", "Query with cache", {"key": str})
async def cached_query(args):
    key = args["key"]
    if key in cache:
        return {"content": [{"type": "text", "text": f"(cached) {cache[key]}"}]}
    
    result = await expensive_operation(key)
    cache[key] = result
    return {"content": [{"type": "text", "text": result}]}
```

---

## å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯

```python
import re

@tool("query_db", "Query database", {"table": str, "where": str})
async def query_db(args):
    table = args["table"]
    
    # é˜²æ­¢ SQL æ³¨å…¥
    if not re.match(r'^[a-zA-Z_]+$', table):
        return {"content": [{"type": "text", "text": "éæ³•è¡¨å"}], "is_error": True}
    
    # ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    ...
```

### 2. æƒé™æ§åˆ¶

```python
ALLOWED_OPERATIONS = ["read", "list"]

@tool("file_op", "File operation", {"operation": str, "path": str})
async def file_op(args):
    op = args["operation"]
    
    if op not in ALLOWED_OPERATIONS:
        return {
            "content": [{"type": "text", "text": f"ä¸å…è®¸çš„æ“ä½œ: {op}"}],
            "is_error": True
        }
    
    # æ‰§è¡Œæ“ä½œ
    ...
```

---

## æ£€æŸ¥æ¸…å•

| æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|--------|------|
| å·¥å…·æœ‰æ¸…æ™°çš„æè¿° | âœ…/âŒ |
| å‚æ•°åæœ‰æ„ä¹‰ | âœ…/âŒ |
| æœ‰å®Œå–„çš„é”™è¯¯å¤„ç† | âœ…/âŒ |
| è¿”å›æ ¼å¼æ­£ç¡® | âœ…/âŒ |
| ä½¿ç”¨ async | âœ…/âŒ |
| æœ‰è¾“å…¥éªŒè¯ | âœ…/âŒ |

---

## ä¸‹ä¸€æ­¥

ğŸ—ï¸ **å®æˆ˜é¡¹ç›®**ï¼š
å‰å¾€ [project_01_resume_analyzer](../projects/project_01_resume_analyzer/) åº”ç”¨è¿™äº›æœ€ä½³å®è·µï¼
