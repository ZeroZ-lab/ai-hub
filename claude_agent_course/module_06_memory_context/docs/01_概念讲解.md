# 01. æ¦‚å¿µè®²è§£ - ä¸Šä¸‹æ–‡ä¸è®°å¿†ç®¡ç†

> è®©ä½ çš„ Agent æ‹¥æœ‰"è®°å¿†"ï¼Œå®ç°çœŸæ­£çš„è¿ç»­å¯¹è¯

## ğŸ¯ æœ¬ç« ç›®æ ‡

- ç†è§£ LLM çš„ä¸Šä¸‹æ–‡çª—å£é™åˆ¶
- æŒæ¡ä¼šè¯ç®¡ç†çš„æ ¸å¿ƒåŸç†
- äº†è§£ Prompt Caching çš„ä¼˜åŒ–æœºåˆ¶
- å­¦ä¹ å‘é‡è®°å¿†ç³»ç»Ÿçš„æ¶æ„

---

## 1. ä¸Šä¸‹æ–‡çª—å£ (Context Window)

### 1.1 ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡çª—å£ï¼Ÿ

**ä¸Šä¸‹æ–‡çª—å£**æ˜¯ LLM ä¸€æ¬¡æ€§èƒ½å¤„ç†çš„æœ€å¤§ token æ•°é‡ã€‚å¯¹äº Claude 3.5 Sonnetï¼š

```
æ€»ä¸Šä¸‹æ–‡çª—å£ = 200,000 tokens
è¾“å…¥ tokens + è¾“å‡º tokens â‰¤ 200,000
```

### 1.2 Token è®¡ç®—

ä¸åŒå†…å®¹çš„ token æ¶ˆè€—ï¼š

| å†…å®¹ç±»å‹ | ç¤ºä¾‹ | çº¦ä¼° Tokens |
|---------|------|-------------|
| è‹±æ–‡æ–‡æœ¬ | "Hello, world!" | ~3 tokens |
| ä¸­æ–‡æ–‡æœ¬ | "ä½ å¥½ï¼Œä¸–ç•Œï¼" | ~6 tokens |
| ä»£ç  | `def hello(): pass` | ~8 tokens |
| JSON | `{"name": "Alice"}` | ~7 tokens |

**ç»éªŒæ³•åˆ™**ï¼š
- è‹±æ–‡ï¼š1 token â‰ˆ 4 å­—ç¬¦
- ä¸­æ–‡ï¼š1 token â‰ˆ 1.5 å­—ç¬¦

### 1.3 ä¸Šä¸‹æ–‡çª—å£çš„æŒ‘æˆ˜

```mermaid
graph TD
    A[é•¿å¯¹è¯] --> B{è¶…å‡ºä¸Šä¸‹æ–‡é™åˆ¶?}
    B -->|æ˜¯| C[âŒ API é”™è¯¯]
    B -->|å¦| D[âœ… æ­£å¸¸å“åº”]
    C --> E[éœ€è¦ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥]
    E --> F[æ»‘åŠ¨çª—å£]
    E --> G[æ‘˜è¦å‹ç¼©]
    E --> H[å‘é‡è®°å¿†]
```

**å¸¸è§é—®é¢˜**ï¼š
1. **Token æº¢å‡º**ï¼šå¯¹è¯å†å²è¿‡é•¿å¯¼è‡´è¶…é™
2. **æˆæœ¬é«˜æ˜‚**ï¼šæ¯æ¬¡éƒ½å‘é€å®Œæ•´å†å²
3. **å“åº”å˜æ…¢**ï¼šå¤„ç†å¤§é‡ä¸Šä¸‹æ–‡è€—æ—¶

---

## 2. Session ç®¡ç†

### 2.1 ä»€ä¹ˆæ˜¯ Sessionï¼Ÿ

**Sessionï¼ˆä¼šè¯ï¼‰**æ˜¯ä¸€æ¬¡å®Œæ•´çš„å¯¹è¯å‘¨æœŸï¼ŒåŒ…å«ï¼š
- å”¯ä¸€çš„ä¼šè¯ ID
- å®Œæ•´çš„æ¶ˆæ¯å†å²
- ä¼šè¯å…ƒæ•°æ®ï¼ˆåˆ›å»ºæ—¶é—´ã€ç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰

### 2.2 ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
    participant User
    participant Agent
    participant Storage
    
    User->>Agent: å¼€å§‹å¯¹è¯
    Agent->>Storage: åˆ›å»º Session
    
    loop å¤šè½®å¯¹è¯
        User->>Agent: å‘é€æ¶ˆæ¯
        Agent->>Storage: è¿½åŠ æ¶ˆæ¯
        Agent->>User: AI å“åº”
        Agent->>Storage: ä¿å­˜å“åº”
    end
    
    User->>Agent: ç»“æŸå¯¹è¯
    Agent->>Storage: å…³é—­ Session
```

### 2.3 Session æ•°æ®ç»“æ„

```python
{
    "session_id": "sess_abc123",
    "created_at": "2024-01-06T10:00:00Z",
    "updated_at": "2024-01-06T10:15:00Z",
    "metadata": {
        "user_id": "user_001",
        "topic": "æŠ€æœ¯å’¨è¯¢"
    },
    "messages": [
        {
            "role": "user",
            "content": "ä»€ä¹ˆæ˜¯ Agentï¼Ÿ"
        },
        {
            "role": "assistant",
            "content": "Agent æ˜¯èƒ½å¤Ÿè‡ªä¸»æ‰§è¡Œä»»åŠ¡çš„ AI ç³»ç»Ÿ..."
        }
    ]
}
```

### 2.4 æŒä¹…åŒ–ç­–ç•¥

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **JSON æ–‡ä»¶** | ç®€å•æ˜“ç”¨ | å¹¶å‘æ€§èƒ½å·® | å­¦ä¹ ã€å°è§„æ¨¡åº”ç”¨ |
| **SQLite** | ç»“æ„åŒ–æŸ¥è¯¢ | å•æœºé™åˆ¶ | ä¸­å°å‹åº”ç”¨ |
| **Redis** | é«˜æ€§èƒ½ | éœ€è¦é¢å¤–æœåŠ¡ | ç”Ÿäº§ç¯å¢ƒ |
| **PostgreSQL** | å¼ºå¤§åŠŸèƒ½ | å¤æ‚åº¦é«˜ | ä¼ä¸šçº§åº”ç”¨ |

---

## 3. Prompt Caching

### 3.1 ä»€ä¹ˆæ˜¯ Prompt Cachingï¼Ÿ

**Prompt Caching** å…è®¸ç¼“å­˜ prompt çš„å›ºå®šéƒ¨åˆ†ï¼Œé¿å…é‡å¤è®¡ç®—ï¼š

```mermaid
graph LR
    A[é¦–æ¬¡è¯·æ±‚] --> B[å®Œæ•´å¤„ç†<br/>100% è´¹ç”¨]
    C[åç»­è¯·æ±‚] --> D[ç¼“å­˜å‘½ä¸­<br/>10% è´¹ç”¨]
    
    style D fill:#90EE90
```

### 3.2 ç¼“å­˜æœºåˆ¶

Claude API è‡ªåŠ¨ç¼“å­˜ **å‰ç¼€å†…å®¹** (prefix content)ï¼š

```python
# ç¬¬ä¸€æ¬¡è¯·æ±‚
messages = [
    {
        "role": "user",
        "content": [
            {
                "type": "text",
                "text": "ã€å¤§é‡æ–‡æ¡£å†…å®¹ - ä¼šè¢«ç¼“å­˜ã€‘",
                "cache_control": {"type": "ephemeral"}
            },
            {
                "type": "text", 
                "text": "é—®é¢˜ï¼šè¿™ä¸ªæ–‡æ¡£è®²äº†ä»€ä¹ˆï¼Ÿ"  # ä¸ç¼“å­˜
            }
        ]
    }
]

# åç»­è¯·æ±‚ - ç¼“å­˜å‘½ä¸­ï¼
messages = [
    {
        "role": "user",
        "content": [
            {
                "type": "text",
                "text": "ã€ç›¸åŒçš„å¤§é‡æ–‡æ¡£ - ä»ç¼“å­˜è¯»å–ã€‘",
                "cache_control": {"type": "ephemeral"}
            },
            {
                "type": "text",
                "text": "é—®é¢˜ï¼šæ–‡æ¡£çš„ç¬¬ä¸‰ç« è®²ä»€ä¹ˆï¼Ÿ"  # æ–°é—®é¢˜
            }
        ]
    }
]
```

### 3.3 ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ

- **TTLï¼ˆTime To Liveï¼‰**ï¼š5 åˆ†é’Ÿ
- **æœ€å°ç¼“å­˜å¤§å°**ï¼š1024 tokens
- **è‡ªåŠ¨å¤±æ•ˆ**ï¼šç¼“å­˜å†…å®¹å˜åŒ–æ—¶

### 3.4 æˆæœ¬åˆ†æ

å‡è®¾æ–‡æ¡£ 10,000 tokensï¼Œå›ç­” 100 ä¸ªé—®é¢˜ï¼š

| æ–¹æ¡ˆ | Input Tokens | æˆæœ¬ï¼ˆæŒ‰ $3/M tokensï¼‰ |
|------|--------------|------------------------|
| **ä¸ä½¿ç”¨ç¼“å­˜** | 10,000 Ã— 100 = 1M | $3.00 |
| **ä½¿ç”¨ç¼“å­˜** | 10,000 + (1,000 Ã— 99) = 109K | $0.33 |

**èŠ‚çœ 90% æˆæœ¬ï¼** ğŸ‰

### 3.5 é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆä½¿ç”¨ Caching**ï¼š
- é—®ç­”æœºå™¨äººï¼ˆå›ºå®šæ–‡æ¡£ï¼‰
- ä»£ç å®¡æŸ¥ï¼ˆå®Œæ•´ä»£ç åº“ï¼‰
- å®¢æœåŠ©æ‰‹ï¼ˆäº§å“æ‰‹å†Œï¼‰

âŒ **ä¸é€‚åˆä½¿ç”¨ Caching**ï¼š
- æ¯æ¬¡å†…å®¹éƒ½å˜åŒ–
- å•æ¬¡å¯¹è¯ï¼ˆæ— é‡å¤ï¼‰
- Token æ•°å¤ªå°‘ï¼ˆ< 1024ï¼‰

---

## 4. å‘é‡è®°å¿† (Vector Memory)

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å‘é‡è®°å¿†ï¼Ÿ

ä¼ ç»Ÿæ•°æ®åº“ï¼š**ç²¾ç¡®åŒ¹é…**
```sql
SELECT * FROM memories WHERE content = 'ä»€ä¹ˆæ˜¯ Agent'
-- âŒ æ‰¾ä¸åˆ°ï¼š"Agent æ˜¯ä»€ä¹ˆ" ï¼ˆè¡¨è¿°ä¸åŒï¼‰
```

å‘é‡æ•°æ®åº“ï¼š**è¯­ä¹‰ç›¸ä¼¼**
```python
query = "Agent æ˜¯ä»€ä¹ˆ"
results = vector_db.search(query, top_k=3)
# âœ… æ‰¾åˆ°ï¼š
# - "ä»€ä¹ˆæ˜¯ Agent"
# - "Agent çš„å®šä¹‰"
# - "Agent ç³»ç»Ÿä»‹ç»"
```

### 4.2 å·¥ä½œåŸç†

```mermaid
graph LR
    A[æ–‡æœ¬] --> B[Embedding<br/>æ¨¡å‹]
    B --> C[å‘é‡<br/>[0.1, 0.3, ...]]
    C --> D[å‘é‡æ•°æ®åº“]
    
    E[æŸ¥è¯¢] --> F[Embedding]
    F --> G[å‘é‡]
    G --> H[ç›¸ä¼¼åº¦æœç´¢]
    D --> H
    H --> I[ç›¸å…³ç»“æœ]
```

### 4.3 Embedding å‘é‡

Embedding å°†æ–‡æœ¬è½¬æ¢ä¸ºé«˜ç»´å‘é‡ï¼ˆé€šå¸¸ 1024-1536 ç»´ï¼‰ï¼š

```python
text = "Claude æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ AI åŠ©æ‰‹"
embedding = get_embedding(text)
# embedding = [0.023, -0.145, 0.678, ..., 0.234]  # 1024 ç»´
```

**ç›¸ä¼¼æ–‡æœ¬çš„å‘é‡æ¥è¿‘**ï¼š
```python
cos_similarity("çŒ«", "ç‹—") = 0.85  # é«˜ç›¸ä¼¼åº¦
cos_similarity("çŒ«", "æ±½è½¦") = 0.12  # ä½ç›¸ä¼¼åº¦
```

### 4.4 å‘é‡æ•°æ®åº“é€‰å‹

| æ•°æ®åº“ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|--------|------|----------|
| **ChromaDB** | ç®€å•æ˜“ç”¨ï¼ŒPython åŸç”Ÿ | å­¦ä¹ ã€åŸå‹å¼€å‘ |
| **FAISS** | Meta å‡ºå“ï¼Œé«˜æ€§èƒ½ | æœ¬åœ°é«˜æ€§èƒ½éœ€æ±‚ |
| **Pinecone** | æ‰˜ç®¡æœåŠ¡ï¼Œæ˜“æ‰©å±• | ç”Ÿäº§ç¯å¢ƒï¼ˆäº‘ï¼‰ |
| **Qdrant** | å¼€æºï¼ŒåŠŸèƒ½å…¨é¢ | ç”Ÿäº§ç¯å¢ƒï¼ˆè‡ªå»ºï¼‰ |

### 4.5 RAG æ¶æ„

**RAG (Retrieval-Augmented Generation)** = æ£€ç´¢ + ç”Ÿæˆ

```mermaid
sequenceDiagram
    participant User
    participant Agent
    participant VectorDB
    participant LLM
    
    User->>Agent: æé—®
    Agent->>VectorDB: è¯­ä¹‰æœç´¢
    VectorDB-->>Agent: ç›¸å…³è®°å¿†
    Agent->>LLM: é—®é¢˜ + è®°å¿†
    LLM-->>Agent: ç”Ÿæˆå›ç­”
    Agent-->>User: å›ç­”
```

**ä¼˜åŠ¿**ï¼š
- ğŸ§  é•¿æœŸè®°å¿†ï¼šä¸å—ä¸Šä¸‹æ–‡çª—å£é™åˆ¶
- ğŸ¯ ç²¾å‡†æ£€ç´¢ï¼šåªè·å–ç›¸å…³ä¿¡æ¯
- ğŸ’° æˆæœ¬ä¼˜åŒ–ï¼šå‡å°‘æ— æ•ˆä¸Šä¸‹æ–‡

---

## 5. ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥

### 5.1 æ»‘åŠ¨çª—å£ (Sliding Window)

ä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼š

```python
MAX_MESSAGES = 10

def get_context(messages):
    return messages[-MAX_MESSAGES:]  # åªä¿ç•™æœ€å 10 æ¡
```

**ä¼˜ç‚¹**ï¼šç®€å•é«˜æ•ˆ  
**ç¼ºç‚¹**ï¼šä¸¢å¤±æ—©æœŸé‡è¦ä¿¡æ¯

### 5.2 æ‘˜è¦å‹ç¼© (Summarization)

å®šæœŸæ€»ç»“å†å²å¯¹è¯ï¼š

```mermaid
graph LR
    A[æ¶ˆæ¯ 1-10] --> B[æ€»ç»“]
    B --> C[æ‘˜è¦]
    D[æ¶ˆæ¯ 11-20] --> E[æ€»ç»“]
    E --> F[æ‘˜è¦]
    C --> G[åˆå¹¶æ‘˜è¦]
    F --> G
    G --> H[æ–°ä¸Šä¸‹æ–‡]
```

**ä¼˜ç‚¹**ï¼šä¿ç•™å…³é”®ä¿¡æ¯  
**ç¼ºç‚¹**ï¼šå¯èƒ½æŸå¤±ç»†èŠ‚

### 5.3 é‡è¦æ€§è¯„åˆ† (Importance Scoring)

ä¸ºæ¶ˆæ¯æ‰“åˆ†ï¼Œä¿ç•™é‡è¦å†…å®¹ï¼š

```python
def score_message(msg):
    score = 0
    if "é‡è¦" in msg: score += 5
    if contains_entities(msg): score += 3
    if is_decision(msg): score += 4
    return score

# ä¿ç•™é«˜åˆ†æ¶ˆæ¯
important_msgs = sorted(messages, key=score_message)[-10:]
```

### 5.4 æ··åˆç­–ç•¥

ç»“åˆå¤šç§æ–¹æ³•ï¼š

```python
context = {
    "summary": summarize(old_messages),      # æ—©æœŸæ‘˜è¦
    "important": get_important(messages),    # é‡è¦æ¶ˆæ¯
    "recent": messages[-5:],                 # æœ€è¿‘å¯¹è¯
    "relevant": vector_search(query)         # ç›¸å…³è®°å¿†
}
```

---

## 6. æœ€ä½³å®è·µå»ºè®®

### 6.1 é€‰æ‹©åˆé€‚çš„ç­–ç•¥

| åº”ç”¨åœºæ™¯ | æ¨èç­–ç•¥ |
|---------|---------|
| çŸ­æœŸä»»åŠ¡ï¼ˆ< 10 è½®ï¼‰ | Session ç®¡ç† |
| å›ºå®šæ–‡æ¡£é—®ç­” | Prompt Caching |
| é•¿æœŸè®°å¿†éœ€æ±‚ | å‘é‡è®°å¿† |
| è¶…é•¿å¯¹è¯ | å‹ç¼© + å‘é‡æ··åˆ |

### 6.2 æˆæœ¬ä¼˜åŒ–

1. **ä¼˜å…ˆä½¿ç”¨ Caching**ï¼šå›ºå®šå†…å®¹å¿…é¡»ç¼“å­˜
2. **æ™ºèƒ½å‹ç¼©**ï¼šè¶…è¿‡ 50K tokens è€ƒè™‘å‹ç¼©
3. **æŒ‰éœ€æ£€ç´¢**ï¼šå‘é‡æœç´¢è®¾ç½®åˆç†çš„ top_k

### 6.3 æ€§èƒ½è°ƒä¼˜

```python
# âŒ ä¸å¥½çš„åšæ³•
context = load_all_history()  # åŠ è½½å…¨éƒ¨å†å²

# âœ… å¥½çš„åšæ³•
context = get_recent(n=10)    # åªåŠ è½½å¿…è¦å†…å®¹
if need_more:
    context += vector_search(query, top_k=3)
```

### 6.4 ç›‘æ§æŒ‡æ ‡

å…³é”®æŒ‡æ ‡ï¼š
- **Token ä½¿ç”¨é‡**ï¼šé¿å…æµªè´¹
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šâ‰¥ 80% ä¸ºä½³
- **æ£€ç´¢å‡†ç¡®ç‡**ï¼štop 3 æ˜¯å¦åŒ…å«ç­”æ¡ˆ
- **å“åº”å»¶è¿Ÿ**ï¼šæ§åˆ¶åœ¨ 2s å†…

---

## 7. å°ç»“

| æŠ€æœ¯ | è§£å†³é—®é¢˜ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|
| **Session ç®¡ç†** | å¯¹è¯è¿ç»­æ€§ | æ‰€æœ‰åº”ç”¨ |
| **Prompt Caching** | æˆæœ¬ä¼˜åŒ– | å›ºå®šä¸Šä¸‹æ–‡ |
| **å‘é‡è®°å¿†** | é•¿æœŸè®°å¿† | çŸ¥è¯†åº“ã€RAG |
| **ä¸Šä¸‹æ–‡å‹ç¼©** | Token é™åˆ¶ | è¶…é•¿å¯¹è¯ |

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. ğŸ¯ **æŒ‰éœ€åŠ è½½**ï¼šåªè·å–å¿…è¦çš„ä¸Šä¸‹æ–‡
2. ğŸ’° **æˆæœ¬ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ Caching
3. ğŸ§  **è¯­ä¹‰ä¼˜äºç²¾ç¡®**ï¼šå‘é‡æœç´¢æ¯”å…³é”®è¯æ›´æ™ºèƒ½
4. ğŸ“Š **æŒç»­ç›‘æ§**ï¼šè¿½è¸ªä½¿ç”¨æƒ…å†µä¼˜åŒ–ç­–ç•¥

---

## ä¸‹ä¸€æ­¥

ç»§ç»­é˜…è¯»ï¼š
- **[02_ä»£ç ç¤ºä¾‹.md](02_ä»£ç ç¤ºä¾‹.md)** - å®é™…ä»£ç æ¼”ç¤º
- **[03_æœ€ä½³å®è·µ.md](03_æœ€ä½³å®è·µ.md)** - ç”Ÿäº§ç¯å¢ƒç»éªŒ

å¼€å§‹å®æˆ˜ï¼š
- **[Project 1: Session Manager](../projects/project_01_session_manager/)** - ä¼šè¯ç®¡ç†å™¨
